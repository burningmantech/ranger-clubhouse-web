<main>
  <h1>Clubhouse Teams</h1>
  <p>
    {{#if this.canManageTeams}}
      <button type="button" class="btn btn-primary" {{action this.newTeam}}>New Team</button>
    {{else}}
      <UiNotice @type="secondary" @icon="hand-point-right" @title="Need Clubhouse Team Help?">
        Contact the Tech Team about creating new teams or adjusting existing ones.<br>
        <TechSupportEmail/>
      </UiNotice>
    {{/if}}
  </p>
  <p>
    Legend:<br>
    <i>MVR Eligible</i> = Allows the team member to submit Motor Vehicle Requests<br>
    <i>PVR Eligible</i> = Allows the team member to submit Personal Vehicle Requests<br>
  </p>

  <FormRow>
    <FormLabel @auto={{true}}>Active Filter</FormLabel>
    <div class="col-auto">
      <ChForm::Select @name="activeFilter"
                      @value={{this.activeFilter}}
                      @options={{this.activeOptions}}
                      @onChange={{action (mut this.activeFilter)}} />
    </div>
    <FormLabel @auto={{true}}>Vehicle Eligibility Filter</FormLabel>
    <div class="col-auto">
      <ChForm::Select @name="mvrEligibilityFilter"
                      @value={{this.mvrEligibilityFilter}}
                      @options={{this.mvrEligibleOptions}}
                      @onChange={{action (mut this.mvrEligibilityFilter)}} />
    </div>
  </FormRow>
  <p>
    <DropdownScrollList @items={{this.teamScrollList}}
                        @thing="team"
                        @blinkBox={{true}}
    />
  </p>

  Showing {{this.viewTeams.length}} of {{pluralize this.teams.length "team"}}
  <UiTable>
    <thead>
    <tr>
      <th>ID</th>
      <th colspan="2">Active / Title</th>
      <th>Type</th>
      <th>Associated Roles</th>
      <th>MVR Eligible?</th>
      <th>PVR Eligible?</th>
      <th>Managers</th>
      {{#if this.canManageTeams}}
        <th>Actions</th>
      {{/if}}
    </tr>
    </thead>
    <tbody>
    {{#each this.viewTeams key="id" as |team|}}
      <tr id="team-{{team.id}}">
        <td class="text-end">{{team.id}}</td>
        <td class="text-center">
          <BooleanIcon @value={{team.active}} @falseIcon="times" @falseClass="text-danger"/>
        </td>
        <td>
          {{team.title}}
        </td>
        <td>{{this.typeLabel team.type}}</td>
        <td>
          {{#if team.role_ids}}
            {{this.roleList team.role_ids}}
          {{else}}
            <i>None</i>
          {{/if}}
        </td>
        <td class="text-center">
          {{if team.mvr_eligible "MVR" "-"}}
        </td>
        <td class="text-center">
          {{if team.pvr_eligible "PVR" "-"}}
        </td>
        <td>
          {{#each team.managers as |person|}}
            <PersonLink @person={{person}} />
            <br>
          {{else}}
            -
          {{/each}}
        </td>
        {{#if this.canManageTeams}}
          <td>
            <UiButton @onClick={{fn this.editTeam team}} @size="sm">
              {{fa-icon "edit"}} Edit
            </UiButton>
          </td>
        {{/if}}
      </tr>
    {{else}}
    <tr>
      <td colspan="{{if this.canManageTeams 9 8}}" class="text-danger">
        No teams found.
      </td>
    </tr>
    {{/each}}
    </tbody>
  </UiTable>
</main>

{{#if this.entry}}
  <ModalDialog @title={{if this.entry.isNew "New Team"  "Edit Team"}} @onEscape={{this.cancelTeam}} as |Modal|>
    <ChForm @formId="role"
            @formFor={{this.entry}}
            @validator={{this.teamValidations}}
            @onSubmit={{this.saveTeam}}
            @onCancel={{this.cancelTeam}} as |f|>
      <Modal.body>
        <FormRow>
          <f.text @name="title" @label="Team Title" @maxlength={{40}} @size={{25}}/>
          <f.select @name="type" @label="Team Type" @options={{this.typeOptions}} />
        </FormRow>
        <fieldset>
          <legend>Team Flags</legend>
          <FormRow>
            <div class="col-12">
              <f.checkbox @name="active" @label="Active"/>
            </div>
            <div class="col-12">
              <f.checkbox @name="mvr_eligible" @label="Team membership grants MVR eligibility"/>
            </div>
            <div class="col-12">
              <f.checkbox @name="pvr_eligible" @label="Team membership grants Personal Vehicle eligibility"/>
            </div>
          </FormRow>
        </fieldset>
        <fieldset>
          <legend>Team Role Grants</legend>
          <FormRow>
            <f.checkboxGroup @name="role_ids" @options={{this.roleOptions}} />
          </FormRow>
        </fieldset>
      </Modal.body>
      <Modal.footer @noAlign={{true}}>
        <f.submit @label={{if this.entry.isNew "Create" "Update"}} @disabled={{this.entry.isSaving}} />
        <UiCancelButton @onClick={{this.cancelTeam}}
                        @disabled={{this.entry.isSaving}} />
        {{#if this.entry.isSaving}}
          <LoadingIndicator/>
        {{/if}}
        {{#unless this.entry.isNew}}
          <div class="ms-auto">
            <button {{action this.removeTeam}} type="button" class="btn btn-danger btn-sm">
              {{fa-icon "trash-alt" type="fas"}} Delete
            </button>
          </div>
        {{/unless}}
      </Modal.footer>
    </ChForm>
  </ModalDialog>
{{/if}}
